<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cemza Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#030519; --bg2:#071227;
  --accent1:#7f5eff; --accent2:#57e8ff;
  --card: rgba(255,255,255,0.03);
  --text:#eaf6ff; --muted:#95adbf;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
body{
  background:
    radial-gradient(900px 420px at 8% 10%, rgba(127,94,255,0.04), transparent),
    linear-gradient(180deg,var(--bg1),var(--bg2));
  color:var(--text);
  display:flex;align-items:center;justify-content:center;padding:28px;
}

/* App card */
.app{
  width:100%; max-width:820px; border-radius:18px; padding:22px;
  background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.008));
  border:1px solid rgba(255,255,255,0.02);
  box-shadow: 0 18px 60px rgba(2,8,24,0.6);
  position:relative; overflow:hidden;
}

/* Background glow decoration */
.app::after{
  content:""; position:absolute; right:-120px; top:-120px; width:420px; height:420px;
  border-radius:50%; filter:blur(80px); opacity:0.08;
  background: linear-gradient(135deg, var(--accent2), transparent);
  pointer-events:none;
}

/* Header */
.header{display:flex; gap:16px; align-items:center}
.logo{width:84px; height:84px; border-radius:16px; display:flex;align-items:center;justify-content:center;
  font-size:40px; background: linear-gradient(135deg,var(--accent1),var(--accent2)); color:#041427;
  box-shadow:0 8px 26px rgba(127,94,255,0.12); animation:floaty 5s ease-in-out infinite;}
.title{display:flex;flex-direction:column}
.h1{margin:0;font-size:24px;font-weight:700;background:linear-gradient(90deg,var(--accent1),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.subtitle{margin:0;color:var(--muted);font-size:13px}

/* Controls */
.controls{margin-top:18px; display:flex; gap:12px; align-items:center; justify-content:space-between}
.leftControls{display:flex; gap:12px; flex:1; align-items:center}
.input{flex:1; padding:14px 16px; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
  border:1px solid rgba(255,255,255,0.03); color:var(--text); font-size:15px; outline:none}
.btnPrimary{padding:12px 14px; border-radius:12px; border:none; background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:#041427; font-weight:800; cursor:pointer}
.smallBtn{padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); background:transparent; color:var(--text); cursor:pointer}

/* App buttons */
.appButtons{margin-top:14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap}
.appBtn{flex:1; min-width:160px; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,0.03);
  background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); color:var(--text); font-weight:700; cursor:pointer}
.appBtn:hover{transform:translateY(-6px); transition:transform .18s}

/* Reply area */
.reply{margin-top:18px; min-height:120px; border-radius:12px; padding:16px; background: linear-gradient(180deg, rgba(255,255,255,0.015), transparent);
  border:1px solid rgba(255,255,255,0.02); font-size:15px; line-height:1.5; overflow-wrap:break-word; position:relative}

/* Waveform */
.waveWrap{position:absolute; right:18px; top:18px; width:120px; height:48px; display:flex; align-items:center; justify-content:center}
.canvas{width:100%; height:48px;}

/* Footer */
.footer{margin-top:12px; display:flex; justify-content:space-between; align-items:center; color:var(--muted); font-size:13px}

/* caret & float */
.caret{display:inline-block;width:10px; animation:blink 1s steps(2) infinite; vertical-align:bottom}
@keyframes blink{0%{opacity:1}50%{opacity:0}100%{opacity:1}}
@keyframes floaty{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}

/* Responsive */
@media (max-width:720px){
  .header{flex-direction:row; gap:12px}
  .waveWrap{display:none}
  .controls{flex-direction:column; align-items:stretch}
}
</style>
</head>
<body>
  <main class="app" role="main" aria-label="Cemza Assistant">
    <header class="header">
      <div class="logo" aria-hidden="false">üêê</div>
      <div class="title">
        <div class="h1">Cemza Assistant</div>
        <div class="subtitle">Offline & app-first ‚Äî ask about Cemza or open socials</div>
      </div>

      <div class="waveWrap" title="voice activity">
        <canvas id="wave" class="canvas" width="300" height="48" aria-hidden="true"></canvas>
      </div>
    </header>

    <section class="controls" aria-label="controls">
      <div class="leftControls">
        <input id="query" class="input" placeholder="Ask about Cemza, say 'open YouTube' / 'open Facebook' / 'open Instagram', or press mic" aria-label="question input">
        <button id="ask" class="btnPrimary">Ask</button>
      </div>
      <div style="display:flex; gap:8px; align-items:center">
        <button id="micBtn" class="smallBtn">Start mic</button>
        <button id="stopMic" class="smallBtn" disabled>Stop mic</button>
      </div>
    </section>

    <nav class="appButtons" aria-label="open apps">
      <button id="btnYT" class="appBtn">Open YouTube</button>
      <button id="btnFB" class="appBtn">Open Facebook / Facebook Lite</button>
      <button id="btnIG" class="appBtn">Open Instagram / Instagram Lite</button>
    </nav>

    <article id="reply" class="reply" aria-live="polite">Ready ‚Äî ask me about Cemza or use the buttons to open apps.</article>

    <div class="footer">
      <div id="voiceStatus">Voice: male enabled</div>
      <div style="display:flex;gap:10px">
        <button id="download" class="appBtn" style="min-width:160px">Download 250 Q&A</button>
      </div>
    </div>
  </main>

<script>
/* ---------------------------
   Data & Q/A (250 entries)
   Only uses the facts below.
   --------------------------- */
const FACTS = {
  stageName: "Cemza the goat",
  realName: "Xolisa Mandla",
  origin: "Cape Town, South Africa",
  creator: "Cemza the goat",
  createdByNote: "He asked his brother Xolani to create me.",
  likes: "creating music for fans",
  musicStatus: "keeps his music low profile ‚Äî prefers careful releases",
  socials: {
    youtube: "https://youtube.com/@cemzathegoat-j5s?si=A2xXwfYzHW9rAt8c",
    facebook: "https://www.facebook.com/cemza.thegoat",
    instagram: "https://www.instagram.com/cemzathegoat?igsh=YzljYTk1ODg3Zg=="
  }
};

/* Generate Q/A arrays programmatically (200 Cemza + 50 AI) */
function makeVariations(baseList, count){
  const prefixes = ["", "Hey,", "Hi,", "Hello,", "Please,", "Quick:", "Tell me,"];
  const suffixes = ["", "?", " please", " now", " please?"];
  const out = [];
  for(const base of baseList){
    for(const p of prefixes){
      for(const s of suffixes){
        out.push((p + " " + base + s).trim());
        if(out.length >= count) return out;
      }
    }
  }
  let k=1;
  while(out.length < count){
    out.push(baseList[(k-1)%baseList.length] + " variant " + k);
    k++;
  }
  return out;
}

const cemzaTemplates = [
  "Who is Cemza?",
  "What is Cemza's real name?",
  "Where is Cemza from?",
  "What does Cemza like?",
  "Who created the Cemza AI?",
  "How did Cemza create the AI?",
  "Is Cemza a rapper?",
  "Does Cemza release music?",
  "Where can I find Cemza online?",
  "Does Cemza have YouTube?",
  "Does Cemza have Instagram?",
  "Does Cemza have Facebook?",
  "Tell me about Cemza",
  "When will Cemza release music?",
  "Why does Cemza keep his music low profile?",
  "What kind of music does Cemza make?",
  "Who is Xolisa Mandla?",
  "Who is Xolani?",
  "Who asked Xolani to build the AI?",
  "What is Cemza's stage name?"
];
const aiTemplates = [
  "Who are you?",
  "What can you do?",
  "Are you friendly?",
  "Who coded you?",
  "Will you have a voice?",
  "Can you open apps?",
  "Can you learn?",
  "Do you sleep?",
  "Are you alive?",
  "Why were you created?"
];

const cemzaQuestions = makeVariations(cemzaTemplates, 200);
const aiQuestions = makeVariations(aiTemplates, 50);
const allPairs = [];

function answerFor(q){
  const s = q.toLowerCase();
  if(/who is cemza|tell me about cemza|what is cemza's stage name/.test(s)) {
    return `${FACTS.stageName} ‚Äî real name ${FACTS.realName} ‚Äî is a rapper from ${FACTS.origin}. He likes ${FACTS.likes} and ${FACTS.musicStatus}.`;
  }
  if(/real name|xolisa/.test(s)) return `His real name is ${FACTS.realName}.`;
  if(/where.*from|origin/.test(s)) return `${FACTS.stageName} is from ${FACTS.origin}.`;
  if(/what does.*like|what.*like|likes/.test(s)) return `He likes ${FACTS.likes}.`;
  if(/who created.*ai|who created you|who made you|who coded you/.test(s)) return `${FACTS.creator} created me. ${FACTS.createdByNote}`;
  if(/how did.*create|how were you created|how did he create/.test(s)) return `${FACTS.createdByNote} They built me to help fans learn about Cemza and protect his image.`;
  if(/is cemza .*rapper|is .*a rapper/.test(s)) return `Yes ‚Äî ${FACTS.stageName} is a rapper from ${FACTS.origin}.`;
  if(/does.*release.*music|release music|released|when will cemza release/.test(s)) return `Cemza keeps his music low profile and prefers careful releases.`;
  if(/where can i find cemza|where.*online|social|youtube|instagram|facebook/.test(s)) return `You can find Cemza on YouTube, Facebook, and Instagram. Use the app buttons to open those apps and search "Cemza the goat".`;
  if(/kind of music|type of music|style of music/.test(s)) return `Cemza focuses on rap and soulful music that speaks to real life and the streets of Cape Town.`;
  if(/who is xolani/.test(s)) return `Xolani is Cemza's brother ‚Äî the person who coded and built this AI.`;
  if(/why does cemza keep|low profile/.test(s)) return `He prefers to craft his sound privately so each release matches his standards.`;
  if(/give me (a )?quote|quote from cemza|music quote/.test(s)){
    const quotes = [
      "Life's a beat ‚Äî I just find the rhythm and make it louder.",
      "Studio lights and late nights, that's where the truth comes out.",
      "I don't chase fame, I chase a feeling ‚Äî the rest follows.",
      "I write for the street, the soul, and the ones who never gave up.",
      "Beat drops, heart stops ‚Äî then the story keeps going."
    ];
    return quotes[Math.floor(Math.random()*quotes.length)];
  }
  /* AI self */
  if(/who are you/.test(s)) return `I am Cemza Assistant ‚Äî a friendly assistant created to share info about ${FACTS.stageName}.`;
  if(/what can you do|what do you do/.test(s)) return `I answer questions about ${FACTS.stageName}, open his social apps, and speak my replies out loud.`;
  if(/will you have a voice|when will you have a voice/.test(s)) return `Don't worry my friend, Xolani who is Cemza's brother will upgrade me soon and you will hear my voice.`;
  if(/can you open apps|open youtube|open facebook|open instagram/.test(s)) return `Yes ‚Äî use the YouTube, Facebook or Instagram buttons and I will try to open the installed app and search "Cemza the goat".`;
  if(/are you friendly/.test(s)) return `Yes ‚Äî I'm designed to be friendly, respectful, and protective of ${FACTS.stageName}'s image.`;
  if(/do you sleep|do you get tired/.test(s)) return `No ‚Äî I'm a digital assistant and I'm ready whenever you are.`;
  if(/can you learn/.test(s)) return `I can be updated by Xolani to improve my knowledge and behavior over time.`;
  if(/are you human/.test(s)) return `No ‚Äî I'm an AI assistant, built with code to help fans learn about ${FACTS.stageName}.`;
  if(/why were you created/.test(s)) return `I was created to help people learn about ${FACTS.stageName} and to share official social links while protecting his privacy.`;
  return null;
}

/* populate Q/A store */
cemzaQuestions.forEach(q => allPairs.push({q:q, a: answerFor(q) || `Sorry, I don't know the answer to that question ‚Äî perhaps you might find out yourself. Try opening YouTube, Facebook or Instagram.`}));
aiQuestions.forEach(q => allPairs.push({q:q, a: answerFor(q) || `Sorry, I don't know the answer to that question ‚Äî perhaps you might find out yourself. Try opening YouTube, Facebook or Instagram.`}));

/* quick friendly map */
const friendlyMap = {
  "hello":"Hey ‚Äî good to see you!",
  "hi":"Hi ‚Äî how can I help you today?",
  "hey":"Hey! What's up?",
  "how are you":"I'm here and ready to help!",
  "how are you?":"I'm good ‚Äî thanks for asking!",
  "bye":"Goodbye ‚Äî stay inspired!",
  "goodbye":"Goodbye ‚Äî see you soon!",
  "good morning":"Good morning ‚Äî have a great day!",
  "good night":"Good night ‚Äî rest well!"
};

/* ---------------------------
   Memory & context
   Short-term memory: lastSubject (e.g., "Cemza")
   --------------------------- */
let memory = {
  lastSubject: null,    // e.g., "Cemza"
  lastQ: null,
  history: []           // limited chat history
};

/* pronoun resolution: replace "he"/"him"/"his" with lastSubject when applicable */
function resolvePronouns(text){
  const t = text;
  if(!memory.lastSubject) return t;
  // only simple replacements to avoid overreach
  return t.replace(/\bhe\b/gi, memory.lastSubject)
          .replace(/\bhim\b/gi, memory.lastSubject)
          .replace(/\bhis\b/gi, memory.lastSubject + "'s");
}

/* ---------------------------
   UI elements & helpers
   --------------------------- */
const replyEl = document.getElementById('reply');
const queryEl = document.getElementById('query');
const askBtn = document.getElementById('ask');
const micBtn = document.getElementById('micBtn');
const stopMicBtn = document.getElementById('stopMic');
const waveCanvas = document.getElementById('wave');
const waveCtx = waveCanvas.getContext('2d');

/* typing + speak with male voice selection */
function pickMaleVoice(){
  if(!('speechSynthesis' in window)) return null;
  const voices = window.speechSynthesis.getVoices();
  if(!voices || voices.length === 0) return null;
  const maleHints = /male|man|david|john|alex|matt|michael|daniel|mark|tom|nick|paul|en-us/i;
  let v = voices.find(v => maleHints.test(v.name));
  if(!v) v = voices.find(v => /en|english/i.test(v.lang));
  return v || voices[0];
}

function speakText(text){
  if(!('speechSynthesis' in window)) return;
  try{
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    const maleVoice = pickMaleVoice();
    if(maleVoice) u.voice = maleVoice;
    u.rate = 1;
    u.pitch = 1.0;
    u.volume = 1;
    u.onstart = ()=> { startWave(); }
    u.onend = ()=> { stopWave(); }
    window.speechSynthesis.speak(u);
  }catch(e){ console.log('TTS error', e); }
}

function typeAndSpeak(text){
  replyEl.textContent = "";
  let i=0;
  const speed = 14;
  const caret = document.createElement('span'); caret.className='caret'; caret.textContent='‚ñå';
  replyEl.appendChild(caret);
  const timer = setInterval(()=> {
    if(i < text.length){
      caret.insertAdjacentText('beforebegin', text.charAt(i));
      i++;
    } else {
      clearInterval(timer);
      if(caret.parentNode) caret.parentNode.removeChild(caret);
    }
  }, speed);
  speakText(text);
}

/* ---------------------------
   Answer lookup and handling
   --------------------------- */
function findAnswer(raw){
  if(!raw) return null;
  let norm = raw.trim();
  norm = resolvePronouns(norm);
  const low = norm.toLowerCase();

  // app commands
  if(/^(open youtube|open yt|youtube open)/.test(low)) return {cmd:'youtube'};
  if(/^(open facebook|open fb|facebook open)/.test(low)) return {cmd:'facebook'};
  if(/^(open instagram|open ig|instagram open)/.test(low)) return {cmd:'instagram'};

  // friendly
  if(friendlyMap[low]) return {answer: friendlyMap[low]};

  // exact match attempts
  for(const p of allPairs){
    if(p.q.toLowerCase() === low) { return {answer: p.a}; }
  }
  // substring match
  for(const p of allPairs){
    const k = p.q.toLowerCase();
    if(k.includes(low) || low.includes(k)) return {answer: p.a};
  }
  // try generated answer
  const gen = answerFor(norm);
  if(gen) return {answer: gen};

  return null;
}

/* handle user request */
function handleAsk(){
  const raw = (queryEl.value || "").trim();
  if(!raw) return;
  queryEl.value = "";
  memory.history.push({from:'user', text:raw});
  memory.lastQ = raw;

  const res = findAnswer(raw);
  if(!res){
    const fallback = "Sorry, I don't know the answer to that question ‚Äî perhaps you might find out yourself. Try opening YouTube, Facebook or Instagram.";
    typeAndSpeak(fallback);
    memory.history.push({from:'assistant', text:fallback});
    return;
  }

  if(res.cmd){
    if(res.cmd === 'youtube'){ openYouTube(); typeAndSpeak("Opening YouTube to search Cemza the goat."); }
    if(res.cmd === 'facebook'){ openFacebook(); typeAndSpeak("Opening Facebook to search Cemza the goat."); }
    if(res.cmd === 'instagram'){ openInstagram(); typeAndSpeak("Opening Instagram to search Cemza the goat."); }
    memory.history.push({from:'assistant', text:'Opened app: ' + res.cmd});
    return;
  }

  // update short-term memory: if answer refers to Cemza, set lastSubject
  if(/cemza|xolisa|the goat/.test(res.answer.toLowerCase())) memory.lastSubject = FACTS.stageName;

  typeAndSpeak(res.answer);
  memory.history.push({from:'assistant', text:res.answer});
}

/* wire ask button */
askBtn.addEventListener('click', handleAsk);
queryEl.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') handleAsk(); });

/* ---------------------------
   Microphone (SpeechRecognition) - real voice conversations
   Uses Web Speech API (webkitSpeechRecognition fallback)
   --------------------------- */
let recog = null;
let recognizing = false;
let audioStream = null;
let analyser = null;
let audioCtx = null;
let micSource = null;
let waveAnimId = null;

function initRecognition(){
  const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SpeechRec) return null;
  const r = new SpeechRec();
  r.lang = 'en-US';
  r.interimResults = false;
  r.maxAlternatives = 1;
  r.onstart = ()=> { recognizing = true; micBtn.disabled = true; stopMicBtn.disabled = false; startWave(); };
  r.onend = ()=> { recognizing = false; micBtn.disabled = false; stopMicBtn.disabled = true; stopWave(); };
  r.onerror = (e)=> { recognizing = false; micBtn.disabled = false; stopMicBtn.disabled = true; stopWave(); console.log('rec error', e); };
  r.onresult = (ev)=>{
    const text = ev.results[0][0].transcript;
    queryEl.value = text;
    handleAsk();
  };
  return r;
}

/* microphone control */
micBtn.addEventListener('click', async ()=>{
  if(!('SpeechRecognition' in window) && !('webkitSpeechRecognition' in window)){
    // still try permissions and show waveform while we capture audio to animate
    try {
      await startMicStream();
      micBtn.disabled = true; stopMicBtn.disabled = false;
      // fallback: use offline listening not available, inform user via reply
      typeAndSpeak("Microphone started. Speak and press Ask to send your text.");
    } catch(e){
      typeAndSpeak("Microphone not available in this browser.");
    }
    return;
  }
  if(!recog) recog = initRecognition();
  if(recog && !recognizing){
    try { recog.start(); } catch(e){ console.log(e); }
  }
});

stopMicBtn.addEventListener('click', async ()=>{
  if(recog && recognizing) try { recog.stop(); } catch(e){}
  await stopMicStream();
  micBtn.disabled = false; stopMicBtn.disabled = true;
});

/* start/stop mic stream for waveform even when SpeechRecognition unavailable */
async function startMicStream(){
  if(audioCtx) return;
  try {
    audioStream = await navigator.mediaDevices.getUserMedia({audio:true});
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    micSource = audioCtx.createMediaStreamSource(audioStream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    micSource.connect(analyser);
    drawWave();
  } catch(e){ console.log('mic stream error', e); throw e; }
}
async function stopMicStream(){
  if(audioStream){
    audioStream.getTracks().forEach(t=>t.stop());
    audioStream = null;
  }
  if(audioCtx){ audioCtx.close(); audioCtx = null; analyser = null; micSource = null; }
  cancelAnimationFrame(waveAnimId);
  clearWave();
}

/* Waveform drawing */
function drawWave(){
  const canvas = waveCanvas;
  const ctx = waveCtx;
  const bufferLength = analyser.fftSize;
  const dataArray = new Uint8Array(bufferLength);
  function draw(){
    waveAnimId = requestAnimationFrame(draw);
    analyser.getByteTimeDomainData(dataArray);
    ctx.fillStyle = "rgba(0,0,0,0)";
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.lineWidth = 2;
    ctx.strokeStyle = "rgba(127,94,255,0.9)";
    ctx.beginPath();
    const sliceWidth = canvas.width * 1.0 / bufferLength;
    let x = 0;
    for(let i=0;i<bufferLength;i++){
      const v = dataArray[i] / 128.0;
      const y = v * canvas.height/2;
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      x += sliceWidth;
    }
    ctx.lineTo(canvas.width, canvas.height/2);
    ctx.stroke();
  }
  draw();
}
function startWave(){
  // if we have analyser, animate via dummy oscillator to show activity; otherwise clear
  if(analyser) return; // already using mic input
  // draw a simple pulsing waveform when speaking
  const canvas = waveCanvas, ctx = waveCtx;
  let t = 0;
  function pulse(){
    waveAnimId = requestAnimationFrame(pulse);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.beginPath();
    ctx.lineWidth = 2;
    ctx.strokeStyle = "rgba(127,94,255,0.95)";
    for(let x=0;x<canvas.width;x++){
      const y = canvas.height/2 + Math.sin((x*0.02) + t) * (10 + Math.sin(t)*6);
      if(x===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
    t += 0.12;
  }
  pulse();
}
function stopWave(){
  if(waveAnimId) cancelAnimationFrame(waveAnimId);
  clearWave();
}
function clearWave(){ waveCtx.clearRect(0,0,waveCanvas.width,waveCanvas.height); }

/* ---------------------------
   App opening (tries Lite and main, falls back to browser)
   Uses visibility detection to prefer installed app
   --------------------------- */
function openWithDetection(schemes, webFallback){
  let tried = 0, finished = false;
  function onVis(){ if(document.hidden) finished = true; }
  document.addEventListener('visibilitychange', onVis);
  function cleanup(){ document.removeEventListener('visibilitychange', onVis); }
  function attempt(){
    if(finished){ cleanup(); return; }
    if(tried >= schemes.length){ cleanup(); window.open(webFallback, '_blank'); return; }
    const uri = schemes[tried++];
    try {
      if(uri.startsWith('intent:') || uri.startsWith('http') || uri.startsWith('https')){
        window.location.href = uri;
      } else {
        const ifr = document.createElement('iframe'); ifr.style.display='none'; ifr.src = uri; document.body.appendChild(ifr);
        setTimeout(()=>{ try{ document.body.removeChild(ifr);}catch(e){} },900);
      }
    } catch(e){}
    setTimeout(()=>{
      if(document.hidden){ finished = true; cleanup(); return; }
      attempt();
    }, 900);
  }
  attempt();
}

/* YouTube open */
function openYouTube(){
  const q = encodeURIComponent('Cemza the goat');
  const web = FACTS.socials.youtube;
  const schemes = [
    `intent://www.youtube.com/results?search_query=${q}#Intent;package=com.google.android.youtube;scheme=https;end;`,
    `vnd.youtube://results?search_query=${q}`,
    `youtube://www.youtube.com/results?search_query=${q}`,
    web
  ];
  openWithDetection(schemes, web);
}

/* Facebook: try Lite then main */
function openFacebook(){
  const q = encodeURIComponent('Cemza the goat');
  const web = FACTS.socials.facebook;
  const schemes = [
    `intent://www.facebook.com/search/top/?q=${q}#Intent;package=com.facebook.lite;scheme=https;end;`,
    `intent://www.facebook.com/search/top/?q=${q}#Intent;package=com.facebook.katana;scheme=https;end;`,
    `fb://search/?q=${q}`,
    web
  ];
  openWithDetection(schemes, web);
}

/* Instagram: try Lite then main */
function openInstagram(){
  const q = encodeURIComponent('Cemza the goat');
  const web = FACTS.socials.instagram;
  const schemes = [
    `intent://instagram.com/_u/cemzathegoat#Intent;package=com.instagram.lite;scheme=https;end;`,
    `intent://instagram.com/_u/cemzathegoat#Intent;package=com.instagram.android;scheme=https;end;`,
    `instagram://user?username=cemzathegoat`,
    `instagram://search?query=${q}`,
    web
  ];
  openWithDetection(schemes, web);
}

/* Wire app buttons */
document.getElementById('btnYT').addEventListener('click', ()=>{ openYouTube(); typeAndSpeak("Opening YouTube to search Cemza the goat."); });
document.getElementById('btnFB').addEventListener('click', ()=>{ openFacebook(); typeAndSpeak("Opening Facebook to search Cemza the goat."); });
document.getElementById('btnIG').addEventListener('click', ()=>{ openInstagram(); typeAndSpeak("Opening Instagram to search Cemza the goat."); });

/* ---------------------------
   Download Q&A file
   --------------------------- */
document.getElementById('download').addEventListener('click', ()=>{
  let out = "250 Questions and Answers about Cemza (based only on provided information)\n\n";
  allPairs.forEach((p,i)=>{ out += (i+1)+". Q: "+p.q+"\n   A: "+p.a+"\n\n"; });
  const blob = new Blob([out], {type:'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'cemza_250_QA.txt'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  typeAndSpeak("Downloaded Q and A file.");
});

/* ---------------------------
   Initial greeting & initialize voices
   --------------------------- */
window.addEventListener('load', ()=> {
  // pre-load voices
  if('speechSynthesis' in window){
    // ensure voices are loaded
    window.speechSynthesis.getVoices();
    setTimeout(()=> window.speechSynthesis.getVoices(), 200);
  }
  typeAndSpeak("Welcome ‚Äî I am Cemza Assistant. Ask me about Cemza or open a social app.");
  // prepare recognition if possible
  if(('SpeechRecognition' in window) || ('webkitSpeechRecognition' in window)){
    try { recog = initRecognition(); } catch(e){ recog = null; }
  }
});

/* Expose handler for mic fallback start/stop when SpeechRecognition not available */
async function initRecognition(){
  const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SpeechRec) return null;
  const r = new SpeechRec();
  r.lang = 'en-US';
  r.interimResults = false;
  r.maxAlternatives = 1;
  r.onstart = ()=> { recognizing = true; micBtn.disabled = true; stopMicBtn.disabled = false; startMicStream().catch(()=>{}); };
  r.onend = ()=> { recognizing = false; micBtn.disabled = false; stopMicBtn.disabled = true; stopMicStream().catch(()=>{}); };
  r.onerror = (e)=> { recognizing = false; micBtn.disabled = false; stopMicBtn.disabled = true; stopMicStream().catch(()=>{}); console.log('rec error', e); };
  r.onresult = (ev)=>{
    const text = ev.results[0][0].transcript;
    queryEl.value = text;
    handleAsk();
  };
  return r;
}

/* start mic stream for waveform if user chooses (even without recognition) */
async function startMicStream(){ if(!audioCtx){ await startMicStream(); } }

/* Prevent accidental selection of stray chars ‚Äî none included in UI */
</script>
</body>
</html>